if("undefined"==typeof jQuery)throw new Error("trackswitchjs's JavaScript requires jQuery. jQuery must be included before trackswitchjs's JavaScript.");(()=>{var t=jQuery.fn.jquery.split(" ")[0].split(".");if(t[0]<2&&t[1]<9||1==t[0]&&9==t[1]&&t[2]<1||4<=t[0])throw new Error("trackswitchjs's JavaScript requires at least jQuery v1.9.1 but less than v4.0.0")})(),(()=>{var n="undefined"!=typeof AudioContext?new AudioContext:"undefined"!=typeof webkitAudioContext?new webkitAudioContext:"undefined"!=typeof mozAudioContext?new mozAudioContext:null,i=(void 0!==document.registerElement&&(document.registerElement("ts-track"),document.registerElement("ts-source")),"trackSwitch"),o={mute:!0,solo:!0,globalsolo:!0,repeat:!1,radiosolo:!1,onlyradiosolo:!1,spacebar:!1,tabview:!1};function e(t,e){this.element=$(t),this.options=$.extend({},o,e),this.options.mute||this.options.solo||(console.error("Cannot disable both solo and mute, reactivating solo"),this.options.solo=!0),this.options.onlyradiosolo&&(this.options.mute=!1,this.options.radiosolo=!0),this._defaults=o,this._name=i,this.numberOfTracks=0,this.longestDuration=0,this.playing=!1,this.repeat=this.options.repeat,this.startTime,this.position=0,this.timerUpdateUI,this.currentlySeeking=!1,this.seekingElement,this.trackProperties=Array(),this.trackSources=Array(),this.trackGainNode=Array(),this.trackBuffer=Array(),this.activeAudioSources=Array(),n&&(this.gainNodeMaster=n.createGain(),this.gainNodeMaster.gain.value=0,this.gainNodeMaster.connect(n.destination)),this.init()}e.prototype.init=function(){var s=this,r=(this.element.addClass("jquery-trackswitch"),0===this.element.find(".main-control").length&&this.element.prepend('<div class="overlay"><span class="activate">Activate</span><p id="overlaytext"></p><p id="overlayinfo"><span class="info">Info</span><span class="text"><strong>trackswitch.js</strong> - open source multitrack audio player<br /><a href="https://github.com/audiolabs/trackswitch.js">https://github.com/audiolabs/trackswitch.js</a></span></p></div><div class="main-control"><ul class="control"><li class="playpause button">Play</li><li class="stop button">Stop</li><li class="repeat button">Repeat</li><li class="timing"><span class="time">--:--:--:---</span> / <span class="length">--:--:--:---</span></li><li class="seekwrap"><div class="seekbar"><div class="seekhead"></div></div></li></ul></div>'),0<this.element.find(".seekable:not(.seekable-img-wrap > .seekable)").length&&this.element.find(".main-control .seekwrap").hide(),this.element.find(".seekable:not(.seekable-img-wrap > .seekable)").each(function(){s.originalImage=this.src,$(this).wrap('<div class="seekable-img-wrap" style="'+$(this).data("style")+'; display: block;"></div>'),$(this).after('<div class="seekwrap" style=" left: '+($(this).data("seekMarginLeft")||0)+"%; right: "+($(this).data("seekMarginRight")||0)+'%;"><div class="seekhead"></div></div>')}),this.element.on("touchstart mousedown",".overlay .activate",$.proxy(this.load,this)),this.element.on("touchstart mousedown",".overlay #overlayinfo .info",$.proxy(function(){this.element.find(".overlay .info").hide(),this.element.find(".overlay .text").show()},this)),this.element.one("loaded",$.proxy(this.loaded,this)),this.element.one("errored",$.proxy(this.errored,this)),$('<ul class="track_list"></ul>'));if(this.numberOfTracks=this.element.find("ts-track").length,0<this.numberOfTracks){if(this.element.find("ts-track").each(function(t){s.trackProperties[t]={mute:this.hasAttribute("mute"),solo:this.hasAttribute("solo"),success:!1,error:!1};var e=s.options.tabview?" tabs":"",i=s.options.radiosolo?" radio":"",o=s.options.onlyradiosolo?" solo":"";r.append('<li class="track'+e+o+'" style="'+($(this).attr("style")||"")+'">'+($(this).attr("title")||"Track "+(t+1))+'<ul class="control">'+(s.options.mute?'<li class="mute button" title="Mute">Mute</li>':"")+(s.options.solo?'<li class="solo button'+i+'" title="Solo">Solo</li>':"")+"</ul></li>")}),this.element.append(r),this.options.radiosolo&&(this.trackProperties[0].solo=!0,this.apply_track_properties()),this.updateMainControls(),!n)return this.element.trigger("errored"),this.element.find("#overlaytext").html("Web Audio API is not supported in your browser. Please consider upgrading."),!1}else this.element.trigger("errored")},e.prototype.destroy=function(){this.element.find(".main-control").remove(),this.element.find(".tracks").remove(),this.element.removeData()},e.prototype.sourceFailed=function(t,e,i){void 0!==this.trackSources[t][e+1]?this.prepareRequest(t,e+1):(this.trackProperties[t].error=!0,this.trackStatusChanged())},e.prototype.decodeAudio=function(t,e,i){var o=this,t=t.response;n.decodeAudioData(t,function(t){o.trackGainNode[e]=n.createGain(),o.trackGainNode[e].connect(o.gainNodeMaster),o.trackBuffer[e]=n.createBufferSource(),o.trackBuffer[e].buffer=t,o.trackProperties[e].success=!0,o.trackStatusChanged()},function(t){o.sourceFailed(e,i,"Error Decoding File Type")})},e.prototype.makeRequest=function(t,e){var i=this,o=$(this.trackSources[t][e]).attr("src"),s=new XMLHttpRequest;s.open("GET",o,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?i.decodeAudio(s,t,e):i.sourceFailed(t,e,"404 - File Not Found"))},s.send()},e.prototype.prepareRequest=function(t,e){void 0!==this.trackSources[t][e]?this.makeRequest(t,e):this.sourceFailed(t,e,"No Source Found")},e.prototype.load=function(t){if(!this.valid_click(t))return!0;t.preventDefault();var o,s,r=this;this.element.find(".overlay span.activate").addClass("fa-spin loading"),0<this.numberOfTracks&&(o=document.createElement("audio"),s={".aac":"audio/aac;",".aif":"audio/aiff;",".aiff":"audio/aiff;",".au":"audio/basic;",".flac":"audio/flac;",".mp1":"audio/mpeg;",".mp2":"audio/mpeg;",".mp3":"audio/mpeg;",".mpg":"audio/mpeg;",".mpeg":"audio/mpeg;",".m4a":"audio/mp4;",".mp4":"audio/mp4;",".oga":"audio/ogg;",".ogg":"audio/ogg;",".wav":"audio/wav;",".webm":"audio/webm;"},this.element.find("ts-track").each(function(t){r.trackSources[t]=$(this).find("ts-source");for(var e,i=0;i<r.trackSources[t].length;i++)e=void 0!==$(r.trackSources[t][i]).attr("type")?$(r.trackSources[t][i]).attr("type")+";":(e=$(r.trackSources[t][i]).attr("src").substring($(r.trackSources[t][i]).attr("src").lastIndexOf(".")),console.log(e),void 0!==s[e]?s[e]:"audio/"+e.substr(1)+";"),o.canPlayType&&o.canPlayType(e).replace(/no/,"")||r.trackSources[t].splice(i,1)}));for(var e=0;e<this.trackSources.length;e++)this.prepareRequest(e,0);return t.stopPropagation(),!1},e.prototype.findLongest=function(){for(var t=0;t<this.numberOfTracks;t++){var e=this.trackBuffer[t].buffer.duration;e>this.longestDuration&&(this.longestDuration=e)}this.element.trigger("loaded")},e.prototype.trackStatusChanged=function(){var e=0,i=0;this.trackProperties.forEach(function(t){e+=t.success||t.error?1:0,i+=t.error?1:0}),e===this.numberOfTracks&&(0===i?this.findLongest():(this.element.trigger("errored"),this.element.find("#overlaytext").html("One or more audio files failed to load.")))},e.prototype.loaded=function(){this.element.find(".overlay").removeClass("loading"),this.element.find(".overlay").hide().remove(),$(this.element).find(".timing .time").html("00:00:00:000"),$(this.element).find(".timing .length").html(this.secondsToHHMMSSmmm(this.longestDuration)),this.apply_track_properties(),this.bindEvents()},e.prototype.errored=function(){this.element.find(".overlay span").removeClass("fa-spin loading"),this.element.addClass("error");var i=this;this.trackProperties.forEach(function(t,e){t.error&&$(i.element).find(".track_list > li:nth-child("+(e+1)+")").addClass("error")}),this.unbindEvents()},e.prototype.unbindEvents=function(){this.element.off("touchstart mousedown",".overlay span"),this.element.off("loaded"),this.element.off("touchstart mousedown",".playpause"),this.element.off("touchstart mousedown",".stop"),this.element.off("touchstart mousedown",".repeat"),this.element.off("mousedown touchstart",".seekwrap"),this.element.off("mousemove touchmove"),this.element.off("mouseup touchend"),this.element.off("touchstart mousedown",".mute"),this.element.off("touchstart mousedown",".solo"),this.options.spacebar&&$(window).unbind("keypress")},e.prototype.bindEvents=function(){var e;this.element.on("touchstart mousedown",".playpause",$.proxy(this.event_playpause,this)),this.element.on("touchstart mousedown",".stop",$.proxy(this.event_stop,this)),this.element.on("touchstart mousedown",".repeat",$.proxy(this.event_repeat,this)),this.element.on("mousedown touchstart",".seekwrap",$.proxy(this.event_seekStart,this)),this.element.on("mousemove touchmove",$.proxy(this.event_seekMove,this)),this.element.on("mouseup touchend",$.proxy(this.event_seekEnd,this)),this.element.on("touchstart mousedown",".mute",$.proxy(this.event_mute,this)),this.element.on("touchstart mousedown",".solo",$.proxy(this.event_solo,this)),this.options.spacebar&&(e=this,$(window).unbind("keypress"),$(window).keypress(function(t){32===t.which&&e.event_playpause(t)}))},e.prototype.valid_click=function(t){return"touchstart"===t.type||"mousedown"===t.type&&1===t.which},e.prototype.secondsToHHMMSSmmm=function(t){var e=(e=parseInt(t/3600)%24)<10?"0"+e:e,i=(i=parseInt(t/60)%60)<10?"0"+i:i,o=t%60,t=(o=(o=o.toString().split(".")[0])<10?"0"+o:o,Math.round(t%1*1e3));return e+":"+i+":"+o+":"+(t<10?"00"+t:t<100?"0"+t:t)},e.prototype.updateMainControls=function(){this.element.find(".playpause").toggleClass("checked",this.playing),this.element.find(".repeat").toggleClass("checked",this.repeat);var t=this.position/this.longestDuration*100;this.element.find(".seekhead").each(function(){$(this).css({left:t+"%"})}),0!==this.longestDuration&&$(this.element).find(".timing .time").html(this.secondsToHHMMSSmmm(this.position))},e.prototype.monitorPosition=function(t){t.position=t.playing&&!t.currentlySeeking?n.currentTime-t.startTime:t.position,t.longestDuration<=t.position&&!t.currentlySeeking&&(t.position=0,t.stopAudio(),t.repeat?t.startAudio(t.position):t.playing=!1),t.updateMainControls()},e.prototype.stopAudio=function(){var t=n.currentTime;this.gainNodeMaster.gain.cancelScheduledValues(t),this.gainNodeMaster.gain.setValueAtTime(1,t),this.gainNodeMaster.gain.linearRampToValueAtTime(0,t+.03);for(var e=0;e<this.numberOfTracks;e++)this.activeAudioSources[e].stop(t+.03);clearInterval(this.timerMonitorPosition)},e.prototype.startAudio=function(t,e){var i=this,o=n.currentTime;downwardRamp=.03;this.position=void 0!==t?t:this.position||0;for(var s=0;s<this.numberOfTracks;s++)this.activeAudioSources[s]=null,this.activeAudioSources[s]=n.createBufferSource(),this.activeAudioSources[s].buffer=this.trackBuffer[s].buffer,this.activeAudioSources[s].connect(this.trackGainNode[s]),void 0!==e?(this.gainNodeMaster.gain.setValueAtTime(0,o+downwardRamp),this.gainNodeMaster.gain.linearRampToValueAtTime(1,o+downwardRamp+.03),this.activeAudioSources[s].start(o+downwardRamp,this.position+downwardRamp,.03+e),this.gainNodeMaster.gain.setValueAtTime(1,o+downwardRamp+.03),this.gainNodeMaster.gain.linearRampToValueAtTime(0,o+downwardRamp+.03+e)):(this.gainNodeMaster.gain.cancelScheduledValues(o),this.gainNodeMaster.gain.setValueAtTime(0,o),this.gainNodeMaster.gain.linearRampToValueAtTime(1,o+.03),this.activeAudioSources[s].start(o,this.position));this.startTime=o-(this.position||0),this.timerMonitorPosition=setInterval(function(){i.monitorPosition(i)},16)},e.prototype.pause=function(){!0===this.playing&&(this.stopAudio(),this.position=n.currentTime-this.startTime,this.playing=!1,this.updateMainControls())},e.prototype.other_instances=function(){return $(".jquery-trackswitch").not(this.element)},e.prototype.pause_others=function(){this.options.globalsolo&&this.other_instances().each(function(){$(this).data("plugin_"+i).pause()})},e.prototype.event_playpause=function(t){return!this.valid_click(t)&&32!==t.which||(t.preventDefault(),this.playing?this.pause():(this.startAudio(),this.pause_others(),this.playing=!0,this.updateMainControls()),t.stopPropagation(),!1)},e.prototype.event_stop=function(t){if(!this.valid_click(t))return!0;t.preventDefault();return this.playing&&this.stopAudio(),this.position=0,this.playing=!1,this.updateMainControls(),t.stopPropagation(),!1},e.prototype.event_repeat=function(t){return!this.valid_click(t)||(t.preventDefault(),this.repeat=!this.repeat,this.updateMainControls(),t.stopPropagation(),!1)},e.prototype.seek=function(t){t=0<=t.type.indexOf("mouse")?t.pageX-$(this.seekingElement).offset().left:t.originalEvent.touches[0].pageX-$(this.seekingElement).offset().left;var e=(e=$(this.seekingElement).width())<1?1:e,i=this.longestDuration*((t<0?0:e<t?e:t)/e*100/100);0<=t&&t<=e&&this.playing?(this.stopAudio(),this.startAudio(i,.03)):this.position=i,this.updateMainControls()},e.prototype.event_seekStart=function(t){return!this.valid_click(t)||(t.preventDefault(),this.seekingElement=$(t.target).closest(".seekwrap"),this.seek(t),this.currentlySeeking=!0,t.stopPropagation(),!1)},e.prototype.event_seekMove=function(t){if(this.currentlySeeking)return t.preventDefault(),this.seek(t),!1;t.stopPropagation()},e.prototype.event_seekEnd=function(t){return t.preventDefault(),this.currentlySeeking&&this.playing&&this.startAudio(),this.currentlySeeking=!1,t.stopPropagation(),!1},e.prototype._index_from_target=function(t){return $(t).closest(".track").prevAll().length},e.prototype.event_solo=function(t){if(!this.valid_click(t))return!0;var e=this._index_from_target(t.target),i=this,o=this.trackProperties[e].solo;(t.shiftKey||this.options.radiosolo)&&$.each(this.trackProperties,function(t,e){i.trackProperties[t].solo=!1}),(this.options.radiosolo||t.shiftKey)&&o?this.trackProperties[e].solo=!0:this.trackProperties[e].solo=!o,this.apply_track_properties()},e.prototype.event_mute=function(t){if(!this.valid_click(t))return!0;t.preventDefault();var e=this._index_from_target(t.target);return this.trackProperties[e].mute=!this.trackProperties[e].mute,this.apply_track_properties(),t.stopPropagation(),!1},e.prototype.switch_image=function(){var i,o=this,s=0;$.each(this.trackProperties,function(t,e){!0===o.trackProperties[t].solo&&(s++,i=o.element.find("ts-track")[t].dataset.img)}),(1!==s||void 0===i||i.length<1)&&(i=this.originalImage),this.element.find(".seekable").attr("src",i)},e.prototype.apply_track_properties=function(){var o=this,s=!1;$.each(this.trackProperties,function(t,e){s=s||o.trackProperties[t].solo}),$.each(this.trackProperties,function(t,e){var i=o.element.find(".track_list li.track:nth-child("+(t+1)+")");o.trackProperties[t].mute?i.find(".mute").addClass("checked"):i.find(".mute").removeClass("checked"),o.trackProperties[t].solo?i.find(".solo").addClass("checked"):i.find(".solo").removeClass("checked"),0<o.trackGainNode.length&&(o.trackGainNode[t].gain.value=1,o.trackProperties[t].mute?o.trackGainNode[t].gain.value=0:o.trackGainNode[t].gain.value=1,s)&&(o.trackProperties[t].solo?o.trackGainNode[t].gain.value=1:o.trackGainNode[t].gain.value=0)}),this.switch_image(),this.deselect()},e.prototype.deselect=function(t){var e="getSelection"in window?window.getSelection():"selection"in document?document.selection:null;"removeAllRanges"in e?e.removeAllRanges():"empty"in e&&e.empty()},$.fn[i]=function(t){return this.each(function(){$(this).data("plugin_"+i)||$(this).data("plugin_"+i,new e(this,t))})}})();